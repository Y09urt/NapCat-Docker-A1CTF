# 群邀请卡片广告撤回功能

## 功能概述

新增了针对QQ群邀请卡片广告的智能检测和自动撤回功能。该功能能够识别通过群卡片形式发送的广告邀请，并自动撤回疑似广告内容。

## 主要特性

### 🎯 智能检测
- **支持多种格式**: CQ码格式 `[CQ:json,data=...]` 和纯JSON格式
- **应用类型识别**: 自动识别 `com.tencent.contact.lua` 和 `com.tencent.structmsg` 类型的群卡片
- **内容分析**: 解析群卡片中的提示文本和群名称信息

### 🚨 高精度判定
- **即时广告模式**: 匹配高风险模式立即判定为广告
  - `2025级.*新生.*群`
  - `新生.*通知.*群`
  - `军训.*通知.*群`
  - `大一.*新生.*群`
  - `新生.*答疑.*群`

- **高风险关键词检测**: 检测新生相关、通知相关等高风险词汇
  - 新生、大一、新生群、新生通知群、通知群、答疑群
  - 班级群、学院群、校群、军训通知、开学通知、转专业群
  - 2025级、大一新生、新生宿舍、新生军训

### ⚖️ 灵活阈值
- **群卡片专用阈值**: 0.6（低于普通文本的0.7）
- **自适应判定**: 根据内容风险程度动态调整置信度

## 检测示例

### ✅ 会被检测为广告的群卡片

```json
[CQ:json,data={"app":"com.tencent.contact.lua","prompt":"推荐群聊: 2025级大一新生通知群"}]
```

```json
{"app":"com.tencent.structmsg","prompt":"邀请你加入群聊: 新生军训通知群"}
```

### ❌ 不会被误判的正常群卡片

```json
[CQ:json,data={"app":"com.tencent.contact.lua","prompt":"推荐群聊: 编程学习交流群"}]
```

## 撤回通知格式

### 群卡片广告通知

检测到群卡片广告时，会发送专门的通知格式：

```
🚨 已自动撤回群卡片广告

👤 发送者: [用户昵称]
📱 消息类型: 群聊邀请卡片
🎯 推广群聊: [群名称]
🔍 检测原因: [检测原因列表]

⚠️ 请勿随意加入陌生群聊，如误判请联系管理员
```

### 撤回失败通知

如果机器人权限不足无法撤回时：

```
🚨 检测到群卡片广告但撤回失败

👤 发送者: [用户昵称]
📱 消息类型: 群聊邀请卡片
🎯 推广群聊: [群名称]
🔍 检测原因: [检测原因]
⚠️ 权限不足，请管理员手动处理
```

## 配置说明

在 `config.py` 中新增了 `group_card_detection` 配置节：

```python
"group_card_detection": {
    # 支持的群卡片应用类型
    "card_app_identifiers": [
        "com.tencent.contact.lua",
        "com.tencent.structmsg"
    ],
    
    # 群卡片提示词匹配模式
    "card_prompt_patterns": [
        r"推荐群聊[：:]\s*(.+)",
        r"邀请你加入群聊[：:]\s*(.+)",
        # ...
    ],
    
    # 群卡片高风险关键词
    "card_high_risk_keywords": [
        "新生", "大一", "新生群", "新生通知群",
        # ...
    ],
    
    # 即时广告模式
    "card_instant_ad_patterns": [
        r"2025级.*新生.*群",
        r"新生.*通知.*群",
        # ...
    ],
    
    # 检测阈值
    "card_detection_threshold": 0.6,  # 群卡片检测阈值
    "card_delete_threshold": 0.6      # 群卡片撤回阈值
}
```

## 测试验证

功能已通过完整测试验证：

1. **新生通知群卡片**: ✅ 正确识别为广告（置信度 0.95）
2. **新生答疑群卡片**: ✅ 正确识别为广告（置信度 0.95）
3. **军训通知群卡片**: ✅ 正确识别为广告（置信度 0.95）
4. **编程学习群卡片**: ✅ 正确识别为正常（置信度 0.55）
5. **普通文本广告**: ✅ 正确识别为广告
6. **正常群聊消息**: ✅ 正确识别为正常

## 使用方式

功能已集成到现有的广告检测系统中，无需额外配置即可使用。管理员可以通过以下命令管理：

- `/ad_control` - 查看广告检测状态
- `/ad_control on/off` - 启用/禁用自动撤回
- `/ad_control threshold X.X` - 设置撤回阈值
- `/ad_detect <消息>` - 手动检测消息内容

## 技术实现

### 核心组件

1. **detect_group_card_advertisement()**: 专门的群卡片检测函数
2. **detect_advertisement()**: 集成检测函数，优先检测群卡片
3. **handle_ad_detection()**: 消息处理器，支持群卡片专用通知

### 检测流程

1. 检查消息是否包含群卡片标识符
2. 解析CQ码或JSON数据
3. 验证应用类型和格式
4. 提取群名称和提示信息
5. 应用检测规则和阈值
6. 生成检测结果和置信度

## 注意事项

- 群卡片使用较低的撤回阈值（0.6 vs 0.7），提高检测敏感度
- 支持不完整的JSON数据，提高容错性
- 详细的日志记录，便于管理员审核和调试
- 与现有广告检测系统完全兼容

---

该功能有效提升了机器人对群邀请卡片广告的检测和处理能力，为群聊环境提供更好的保护。
