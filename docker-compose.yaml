# docker-compose.yml
version: "3"
services:
    napcat:
        environment:
            - NAPCAT_UID=${NAPCAT_UID:-1000}
            - NAPCAT_GID=${NAPCAT_GID:-1000}
            - MODE=nonebot
        ports:
            - 3000:3000
            - 3001:3001
            - 6099:6099
        container_name: napcat
        restart: always
        image: mlikiowa/napcat-docker:latest
        volumes:
            - ./napcat/config:/app/napcat/config
            - ./ntqq:/app/.config/QQ
        networks:
            - nonebot_network
        mac_address: "02:42:ac:11:00:02"
    
    nonebot:
        container_name: nonebot
        image: python:3.11-slim
        restart: always
        environment:
            - TZ=Asia/Shanghai
        ports:
            - 8080:8080
        volumes:
            - ./nonebot:/app/nonebot
            - ./nonebot/pip.conf:/root/.pip/pip.conf
        working_dir: /app/nonebot
        command: >
            bash -c "
            echo 'ğŸŒ é…ç½®Debianè½¯ä»¶æº...' &&
            sed -i 's|deb.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources &&
            sed -i 's|security.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources &&
            echo 'âœ… Debianè½¯ä»¶æºé…ç½®å®Œæˆ' &&
            echo 'ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–...' &&
            apt-get update &&
            apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei fontconfig &&
            fc-cache -fv &&
            echo 'âœ… ä¸­æ–‡å­—ä½“å®‰è£…å®Œæˆ' &&
            echo 'ğŸŒ é…ç½®Pythoné•œåƒæº...' &&
            mkdir -p /root/.pip &&
            pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple &&
            pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn &&
            echo 'âœ… Pythoné•œåƒæºé…ç½®å®Œæˆ' &&
            echo 'ğŸš€ å®‰è£…ä¾èµ–åŒ…...' &&
            pip install --no-cache-dir -r requirements.txt &&
            echo 'âœ… ä¾èµ–å®‰è£…å®Œæˆ' &&
            chmod +x start.sh &&
            ./start.sh
            "
        networks:
            - nonebot_network
        depends_on:
            - napcat

networks:
    nonebot_network:
        driver: bridge