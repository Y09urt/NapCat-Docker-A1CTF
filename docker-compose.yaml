# docker-compose.yml
version: "3"
services:
    napcat:
        environment:
            - NAPCAT_UID=${NAPCAT_UID:-1000}
            - NAPCAT_GID=${NAPCAT_GID:-1000}
            - MODE=nonebot
        ports:
            - 3000:3000
            - 3001:3001
            - 6099:6099
        container_name: napcat
        restart: always
        image: mlikiowa/napcat-docker:latest
        volumes:
            - ./napcat/config:/app/napcat/config
            - ./ntqq:/app/.config/QQ
        networks:
            - nonebot_network
        mac_address: "02:42:ac:11:00:02"
    
    nonebot:
        container_name: nonebot
        image: python:3.11-slim
        restart: always
        environment:
            - TZ=Asia/Shanghai
        ports:
            - 8080:8080
        volumes:
            - ./nonebot:/app/nonebot
            - ./nonebot/pip.conf:/root/.pip/pip.conf
        working_dir: /app/nonebot
        command: >
            bash -c "
            echo '🌐 配置Debian软件源...' &&
            sed -i 's|deb.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources &&
            sed -i 's|security.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources &&
            echo '✅ Debian软件源配置完成' &&
            echo '🔧 安装系统依赖...' &&
            apt-get update &&
            apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei fontconfig &&
            fc-cache -fv &&
            echo '✅ 中文字体安装完成' &&
            echo '🌐 配置Python镜像源...' &&
            mkdir -p /root/.pip &&
            pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple &&
            pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn &&
            echo '✅ Python镜像源配置完成' &&
            echo '🚀 安装依赖包...' &&
            pip install --no-cache-dir -r requirements.txt &&
            echo '✅ 依赖安装完成' &&
            chmod +x start.sh &&
            ./start.sh
            "
        networks:
            - nonebot_network
        depends_on:
            - napcat

networks:
    nonebot_network:
        driver: bridge